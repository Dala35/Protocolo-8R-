<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo 8R+ | Etapa 7: Corre√ß√£o de Carregamento</title>
    <!-- Carregamento do Tailwind CSS para Estiliza√ß√£o R√°pida e Responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padr√£o */
        body { font-family: 'Inter', sans-serif; }
        /* Estilos para bot√µes e inputs focados */
        input:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.4); }
        .card-shadow { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="relative">
        <!-- O conte√∫do ser√° injetado aqui pelo JavaScript -->
    </div>

    <script type="module">
        // ===========================================================================
        // üõ†Ô∏è BLOCO 0: CONFIGURA√á√ÉO DO FIREBASE E FERRAMENTAS
        // ===========================================================================
        
        // Importa√ß√µes Firebase (Vers√£o CDN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Vari√°veis globais (dispon√≠veis no ambiente Canvas)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Estado Global da Aplica√ß√£o
        let appState = {
            user: null,
            currentScreen: 'Dashboard',
            db: null,
            auth: null,
            authReady: false,
            metrics: { frequenciaCardiaca: 0, nivelEstresse: 0 },
            aiAdjustment: null,
            isLoading: false, // Inicia como false, mas a fun√ß√£o de inicializa√ß√£o define como true
            goals: { focus: '', nextSteps: '' }
        };

        // --- Constantes de Caminho do Firestore ---
        const PUBLIC_METRICS_PATH = `/artifacts/${appId}/public/data/health_metrics/patient_001`;
        const getTherapyLogPath = (caregiverUserId) => `/artifacts/${appId}/users/${caregiverUserId}/therapy_notes/patient_002_log`;
        const getPatientGoalsPath = (patientUserId) => `/artifacts/${appId}/users/${patientUserId}/goals/current_focus`;

        // ===========================================================================
        // üåü BLOCO 1: MICROSSERVI√áO DE PROTE√á√ÉO E COMPAIX√ÉO (Mocks de Back-end)
        // ===========================================================================

        // --- 1.1. MOCK DE CRIPTOGRAFIA AES-256 (Pilar de Prote√ß√£o) ---
        const mockEncrypt = (data) => {
            if (!data || typeof data !== 'string') return '';
            const encrypted = data.split('').map(char => String.fromCharCode(char.charCodeAt(0) ^ 123)).join('');
            return btoa(encrypted); 
        };

        const mockDecrypt = (encrypted) => {
            if (!encrypted) return '';
            try {
                const decoded = atob(encrypted);
                const decrypted = decoded.split('').map(char => String.fromCharCode(char.charCodeAt(0) ^ 123)).join('');
                return decrypted;
            } catch (e) {
                return 'ERRO: Falha ao descriptografar dado.';
            }
        };

        // --- 1.2. MOCK DE AUTENTICA√á√ÉO JWT (Pilar de Prote√ß√£o) ---
        const mockAuthLogin = (username, password) => {
            if (username === 'medico' && password === '123') {
                const encryptedName = mockEncrypt("Dr. Jo√£o Cust√≥dio (Cuidador)");
                return { token: 'jwt.medic.token', userId: 'medic001', name: "Dr. Jo√£o Cust√≥dio", role: 'Cuidador', encryptedName };
            }
            if (username === 'paciente' && password === '123') {
                const encryptedName = mockEncrypt("Maria da Silva (Paciente)");
                return { token: 'jwt.patient.token', userId: 'patient002', name: "Maria da Silva", role: 'Paciente', encryptedName };
            }
            return null;
        };

        // --- 1.3. MOCK DO MOTOR DE TERAPIA DE IA (Pilar de Compaix√£o) ---
        const simulateAIAdjustment = async (metrics) => {
            const { frequenciaCardiaca, nivelEstresse } = metrics;
            
            const predicao = nivelEstresse > 5.5 ? 'Risco Elevado' : 'Seguro/Est√°vel';
            let ajusteRecomendado = 'Manter a terapia atual (Protocolo 8R+).';

            if (predicao === 'Risco Elevado') {
                if (nivelEstresse > 7.0) {
                    ajusteRecomendado = 'PAUSA IMEDIATA. Recomendar biofeedback neuroemocional (√Åudio 432Hz). Ativar dose de resgate de IL-15 (Imunol√≥gico).';
                } else if (frequenciaCardiaca > 90) {
                    ajusteRecomendado = 'Ajuste de Foco. Reduzir a dificuldade da sess√£o cognitiva em 25%. Priorizar hidrata√ß√£o e Microbiota (Curcumina).';
                }
            } else {
                if (nivelEstresse < 3.0 && frequenciaCardiaca < 75) {
                    ajusteRecomendado = 'Avan√ßo de Fase. O paciente responde bem. Sugerir introdu√ß√£o da pr√≥xima etapa Gen√©tica (CRISPR/Cas9) e aumento da complexidade da Imunoterapia.';
                }
            }

            return new Promise(resolve => setTimeout(() => resolve({ predicao, ajusteTerapeutico: ajusteRecomendado, mensagemAI: 'An√°lise de Risco Completa' }), 1000));
        };
        
        // ===========================================================================
        // üöÄ BLOCO 2: GEST√ÉO DO ESTADO E RENDERIZA√á√ÉO
        // ===========================================================================

        const navigate = (screen) => {
            appState.currentScreen = screen;
            renderApp();
        };

        const handleLogout = () => {
            localStorage.clear();
            appState.user = null;
            appState.aiAdjustment = null;
            appState.currentScreen = 'Dashboard';
            renderApp();
        };

        const updateMetrics = (newMetrics) => {
            appState.metrics = newMetrics;
            renderApp();
        };

        const updateAIAdjustment = (adjustment) => {
            appState.aiAdjustment = adjustment;
            renderApp();
        };

        const updateGoals = (newGoals) => {
            appState.goals = newGoals;
            renderApp();
        };

        // Fun√ß√£o principal que redesenha toda a aplica√ß√£o
        const renderApp = () => {
            const appContainer = document.getElementById('app');
            let html = '';

            if (appState.isLoading) {
                html = renderLoadingScreen();
            } else if (appState.user) {
                html = renderHeader() + renderMainContent();
            } else {
                html = renderLoginScreen();
            }
            
            // Adiciona o rodap√© fixo
            html += renderFooter();
            
            appContainer.innerHTML = html;
            
            // Re-anexa eventos ap√≥s a renderiza√ß√£o
            if (appState.isLoading === false) { // Verifica se n√£o est√° carregando antes de anexar eventos de UI
                if (appState.user) {
                    attachHeaderEvents();
                    attachMainContentEvents();
                } else {
                    attachLoginEvents();
                }
            }
            
        };
        
        // ===========================================================================
        // üñ•Ô∏è BLOCO 3: RENDERING DE COMPONENTES
        // ===========================================================================

        const getStatusColor = (predicao) => {
            if (predicao.includes('Risco')) return 'bg-red-500 border-red-500';
            if (predicao.includes('Seguro')) return 'bg-green-500 border-green-500';
            return 'bg-yellow-500 border-yellow-500';
        };
        
        const renderLoadingScreen = () => `
            <div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                <p class="text-xl font-medium text-indigo-600">Conectando ao N√∫cleo de Dados...</p>
            </div>
        `;

        // --- 3.1. Header ---
        const renderHeader = () => {
            const isCaregiver = appState.user?.role === 'Cuidador';
            const navItems = isCaregiver 
                ? ['Dashboard', 'Monitoramento', 'Relat√≥rios', 'Perfil']
                : ['Progresso', 'Metas', 'Respira√ß√£o', 'Perfil'];
            
            const navButtons = navItems.map(screen => `
                <button
                    data-screen="${screen}"
                    class="nav-button px-3 py-1 rounded-full text-sm font-medium transition-all ${
                        appState.currentScreen === screen ? 'bg-indigo-400 shadow-md transform scale-105' : 'hover:bg-indigo-600'
                    }"
                >
                    ${screen}
                </button>
            `).join('');

            return `
                <header class="bg-gradient-to-r from-blue-900 to-indigo-800 text-white card-shadow p-4 sticky top-0 z-10">
                    <div class="max-w-7xl mx-auto flex justify-between items-center">
                        <h1 class="text-2xl font-extrabold tracking-tight cursor-pointer" id="logo-nav">
                            Protocolo 8R+
                        </h1>
                        <nav class="flex space-x-4">
                            ${navButtons}
                        </nav>
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-light hidden sm:inline">${appState.user.role === 'Cuidador' ? 'M√âDICO' : 'PACIENTE'}: ${appState.user.name.split(' ')[0]}</span>
                            <button
                                id="logout-button"
                                class="px-3 py-1 rounded-full text-sm font-medium bg-red-500 hover:bg-red-600 transition-all shadow-md"
                            >
                                Sair
                            </button>
                        </div>
                    </div>
                </header>
            `;
        };

        const attachHeaderEvents = () => {
            document.getElementById('logout-button')?.addEventListener('click', handleLogout);
            document.getElementById('logo-nav')?.addEventListener('click', () => {
                const defaultScreen = appState.user.role === 'Cuidador' ? 'Dashboard' : 'Progresso';
                navigate(defaultScreen);
            });
            document.querySelectorAll('.nav-button').forEach(button => {
                button.addEventListener('click', (e) => navigate(e.target.dataset.screen));
            });
        };

        // --- 3.2. Login Screen ---
        const renderLoginScreen = (error = '') => `
            <div class="min-h-screen flex items-center justify-center bg-gray-50 p-4">
                <div class="bg-white p-8 rounded-xl card-shadow w-full max-w-md border-t-8 border-indigo-600">
                    <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Acesso ao Protocolo 8R+</h2>
                    ${error ? `<p id="login-error" class="text-red-600 bg-red-100 p-2 rounded-lg mb-4 text-sm text-center">${error}</p>` : ''}
                    
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome de Usu√°rio</label>
                    <input type="text" id="username-input" value="medico" class="w-full p-3 border border-gray-300 rounded-lg mb-4" placeholder="medico ou paciente"/>

                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password-input" value="123" class="w-full p-3 border border-gray-300 rounded-lg mb-6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>

                    <button id="login-button" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 card-shadow transform hover:scale-[1.01]">
                        Entrar (Simula√ß√£o JWT)
                    </button>
                    <p class="mt-4 text-xs text-center text-gray-500">
                        üîì **CONTAS TESTE:** medico/123 (Cuidador) | paciente/123 (Paciente)
                    </p>
                </div>
            </div>
        `;

        const attachLoginEvents = () => {
            document.getElementById('login-button')?.addEventListener('click', handleLogin);
        };

        const handleLogin = () => {
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            
            const user = mockAuthLogin(username, password);
            
            if (user) {
                localStorage.setItem('token', user.token);
                localStorage.setItem('userId', user.userId);
                localStorage.setItem('encryptedName', user.encryptedName);
                localStorage.setItem('role', user.role);
                
                appState.user = user;
                appState.currentScreen = user.role === 'Cuidador' ? 'Dashboard' : 'Progresso';
                renderApp();
            } else {
                // Re-renderiza a tela de login com erro
                document.getElementById('app').innerHTML = renderLoginScreen('Credenciais inv√°lidas. Tente M√©dico/123 ou Paciente/123') + renderFooter();
                attachLoginEvents();
            }
        };


        // --- 3.3. Log de A√ß√£o Terap√™utica (Sub-Componente) ---
        const renderTherapyNoteLog = () => {
            if (!appState.aiAdjustment) return '';
            
            // Tenta obter o estado atual do DOM para evitar perda ao re-renderizar
            const statusElement = document.getElementById('log-status');
            const noteTextarea = document.getElementById('note-textarea');
            const status = statusElement ? statusElement.textContent : '';
            const note = noteTextarea ? noteTextarea.value : '';

            
            // Renderiza√ß√£o do HTML do Log
            return `
                <div class="bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200 mt-4">
                    <h4 class="text-lg font-bold text-gray-800 border-b pb-2 mb-3">
                        Registro de A√ß√£o Terap√™utica (Pilar da Prote√ß√£o - Log de Governan√ßa)
                    </h4>
                    <textarea
                        id="note-textarea"
                        placeholder="Adicione suas notas sobre a decis√£o (Obrigat√≥rio)"
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm"
                        rows="3"
                    >${note}</textarea>
                    <div class="mt-3 flex justify-end space-x-3">
                        <button
                            id="approve-log-button"
                            data-action="Aprovado e Executado"
                            class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition disabled:opacity-50"
                            ${note.trim().length === 0 ? 'disabled' : ''}
                        >
                            Aprovar & Registrar
                        </button>
                        <button
                            id="reject-log-button"
                            data-action="Rejeitado/Ajuste Manual"
                            class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition disabled:opacity-50"
                            ${note.trim().length === 0 ? 'disabled' : ''}
                        >
                            Rejeitar & Registrar
                        </button>
                    </div>
                    <p id="log-status" class="mt-3 text-sm text-center font-medium text-gray-700">${status}</p>
                </div>
            `;
        };
        
        // --- 3.4. Dashboard do Cuidador ---
        const renderCaregiverDashboard = () => {
            const metrics = appState.metrics;
            const aiAdjustment = appState.aiAdjustment;
            const loading = appState.isLoading;
            
            const adjustmentHtml = aiAdjustment ? `
                <div class="mt-4 p-4 rounded-xl shadow-inner bg-opacity-10 border-l-4 ${getStatusColor(aiAdjustment.predicao)}">
                    <p class="font-bold text-gray-800">Previs√£o da IA: 
                        <span class="uppercase font-extrabold text-white px-2 py-0.5 rounded-full text-sm ${getStatusColor(aiAdjustment.predicao).replace('border-', 'bg-')}">
                            ${aiAdjustment.predicao}
                        </span>
                    </p>
                    <p class="mt-2 text-gray-700 text-lg font-medium">${aiAdjustment.ajusteTerapeutico}</p>
                </div>
            ` : '';

            return `
                <div class="max-w-7xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-6 border-b pb-2">
                        Dashboard do Cuidador | Vis√£o Integrada (IA)
                    </h2>
                    
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <!-- Bloco de Monitoramento -->
                        <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-indigo-500">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center"><span class="text-indigo-500 mr-2">‚ù§Ô∏è</span> Monitoramento Real-Time (Firestore)</h3>
                            <p class="text-4xl font-bold text-gray-800">${metrics.frequenciaCardiaca.toFixed(1)} <span class="text-lg font-normal">BPM</span></p>
                            <p class="text-4xl font-bold text-gray-800 mt-2">${metrics.nivelEstresse.toFixed(1)} <span class="text-lg font-normal">Estresse (0-10)</span></p>
                            <p class="text-xs text-green-500 mt-3">‚úÖ Dados persistentes e em tempo real.</p>
                        </div>

                        <!-- Bloco da IA e Log de A√ß√£o -->
                        <div class="md:col-span-2 bg-white p-6 rounded-xl card-shadow border-l-4 border-purple-600">
                            <h3 class="text-xl font-semibold text-purple-700 mb-4 flex items-center"><span class="text-purple-600 mr-2">üß†</span> Motor de Terapia (IA Adaptativa)</h3>
                            
                            <button
                                id="request-ai-button"
                                ${loading ? 'disabled' : ''}
                                class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-150 disabled:opacity-50 flex justify-center items-center"
                            >
                                ${loading ? 'Analisando dados...' : 'Solicitar Ajuste Terap√™utico da IA'}
                            </button>

                            ${adjustmentHtml}
                            
                            <!-- NOVO: Componente de Log -->
                            ${renderTherapyNoteLog()}
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- 3.5. Defini√ß√£o de Metas (Ecr√£ do Paciente) ---
        const renderGoalSettingScreen = (status = '') => {
            const goals = appState.goals;
            
            // Tenta obter o estado atual do DOM
            const goalsFocusElement = document.getElementById('goals-focus-textarea');
            const goalsNextStepsElement = document.getElementById('goals-next-steps-textarea');
            const currentFocus = goalsFocusElement ? goalsFocusElement.value : goals.focus;
            const currentNextSteps = goalsNextStepsElement ? goalsNextStepsElement.value : goals.nextSteps;

            const isDisabled = currentFocus.trim() === '' || currentNextSteps.trim() === '';

            return `
                <div class="max-w-4xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">
                        Metas e Foco Pessoal (Pilar da Co-cria√ß√£o)
                    </h2>
                    <div class="bg-white p-8 rounded-xl card-shadow border-l-8 border-teal-600">
                        <p class="text-gray-600 mb-6">
                            Definir o seu foco ajuda a IA e o seu Cuidador a orientarem melhor o Protocolo 8R+.
                        </p>

                        <label class="block text-lg font-semibold text-gray-700 mb-2">Foco Principal Atual</label>
                        <textarea
                            id="goals-focus-textarea"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-6"
                            rows="3"
                        >${currentFocus}</textarea>

                        <label class="block text-lg font-semibold text-gray-700 mb-2">Pr√≥ximos Passos Terap√™uticos</label>
                        <textarea
                            id="goals-next-steps-textarea"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-6"
                            rows="3"
                        >${currentNextSteps}</textarea>
                        
                        <button
                            id="save-goals-button"
                            class="w-full py-3 bg-teal-600 text-white font-bold text-lg rounded-lg card-shadow hover:bg-teal-700 transition transform hover:scale-[1.01] disabled:opacity-50"
                            ${isDisabled ? 'disabled' : ''}
                        >
                            ${status || 'Salvar Minhas Metas'}
                        </button>
                        ${status ? `<p class="mt-3 text-center text-sm font-medium text-gray-700">${status}</p>` : ''}
                    </div>
                </div>
            `;
        };

        // --- 3.6. Ecr√£s Placeholder (Simplificados) ---
        const renderProfileScreen = () => {
            const encryptedName = localStorage.getItem('encryptedName');
            const profileName = mockDecrypt(encryptedName); 
            const protocol = mockDecrypt(mockEncrypt("Fase 1: Ajuste Imunol√≥gico e Neuroemocional - Protocolo Alpha-1"));
            
            return `
                <div class="max-w-3xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
                    <h2 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">Perfil do Usu√°rio (Pilar de Prote√ß√£o AES-256)</h2>
                    <div class="bg-white p-8 rounded-xl card-shadow space-y-6">
                        <div>
                            <label class="text-sm font-medium text-gray-500 block mb-1">Nome Decriptografado</label>
                            <p class="text-xl font-bold text-gray-900">${profileName}</p>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-500 block mb-1">Protocolo 8R+ Atual (Dado Sens√≠vel)</label>
                            <p class="text-lg text-gray-800 bg-indigo-50 p-3 rounded-lg border-l-4 border-indigo-400">${protocol}</p>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderPatientProgressScreen = () => `
            <div class="max-w-4xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
                <h2 class="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">Meu Progresso 8R+ (Pilar de Co-cria√ß√£o)</h2>
                <div class="bg-white p-8 rounded-xl card-shadow">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">M√©tricas Vivas</h3>
                    <p class="text-xl text-gray-700 font-medium">Batimento Card√≠aco: <span class="text-indigo-600 font-bold">${appState.metrics.frequenciaCardiaca.toFixed(1)} BPM</span></p>
                    <p class="text-xl text-gray-700 font-medium mt-2">N√≠vel de Estresse: <span class="text-indigo-600 font-bold">${appState.metrics.nivelEstresse.toFixed(1)} (0-10)</span></p>
                    <p class="mt-6 text-sm text-green-500">Dados em tempo real via Firestore.</p>
                </div>
            </div>
        `;

        const renderPlaceholderScreen = (title) => `
            <div class="p-6 text-center text-xl font-semibold text-gray-700 min-h-[90vh]">
                <div class="mt-12 p-8 bg-white rounded-xl card-shadow">${title} - Placeholder</div>
            </div>
        `;
        
        const renderFooter = () => `
            <footer class="p-4 text-center text-xs text-gray-500 border-t mt-4">
                Sistema Protocolo 8R+ Integrado V7. **Corre√ß√£o de Estabilidade de Carregamento.**
            </footer>
        `;
        
        const renderMainContent = () => {
            const userRole = appState.user.role;
            const screen = appState.currentScreen;
            let contentHtml = '';

            if (userRole === 'Cuidador') {
                switch (screen) {
                    case 'Dashboard': contentHtml = renderCaregiverDashboard(); break;
                    case 'Monitoramento': contentHtml = renderPlaceholderScreen('Monitoramento Detalhado (M√≥d. M√©dico)'); break;
                    case 'Relat√≥rios': contentHtml = renderPlaceholderScreen('Relat√≥rio Anal√≠tico (M√≥d. M√©dico)'); break;
                    case 'Perfil': contentHtml = renderProfileScreen(); break;
                    default: contentHtml = renderCaregiverDashboard();
                }
            } else { // Paciente
                switch (screen) {
                    case 'Progresso': contentHtml = renderPatientProgressScreen(); break;
                    case 'Metas': contentHtml = renderGoalSettingScreen(); break;
                    case 'Respira√ß√£o': contentHtml = renderPlaceholderScreen('Exerc√≠cio de Respira√ß√£o Guiada (M√≥d. Co-cria√ß√£o)'); break;
                    case 'Perfil': contentHtml = renderProfileScreen(); break;
                    default: contentHtml = renderPatientProgressScreen();
                }
            }
            return `<main>${contentHtml}</main>`;
        };

        // ===========================================================================
        // ‚ö° BLOCO 4: EVENTOS E L√ìGICA DE INTERA√á√ÉO
        // ===========================================================================

        const handleAIRequest = async () => {
            appState.isLoading = true;
            updateAIAdjustment(null); 
            
            try {
                const adjustment = await simulateAIAdjustment(appState.metrics);
                updateAIAdjustment(adjustment);
            } catch (error) {
                updateAIAdjustment({ predicao: 'Erro', ajusteTerapeutico: 'Falha de comunica√ß√£o com o Motor de Terapia.', mensagemAI: 'Erro.' });
            } finally {
                appState.isLoading = false;
                renderApp(); 
            }
        };
        
        const logTherapyAction = async (actionType) => {
            const noteValue = document.getElementById('note-textarea').value;
            if (!appState.db || !appState.user || !appState.aiAdjustment || noteValue.trim().length === 0) {
                document.getElementById('log-status').textContent = '‚ö†Ô∏è A nota √© obrigat√≥ria para o registro.';
                return;
            }
            
            document.getElementById('log-status').textContent = 'Registrando...';
            const logData = {
                caregiverId: appState.user.userId,
                patientId: 'patient002', 
                actionType: actionType,
                aiRecommendation: appState.aiAdjustment.ajusteTerapeutico,
                caregiverNote: noteValue,
                metricsSnapshot: appState.metrics,
                timestamp: Date.now(),
            };
            
            const logDocRef = doc(appState.db, getTherapyLogPath(appState.user.userId));

            try {
                await setDoc(logDocRef, { latestLog: logData }, { merge: true });
                document.getElementById('log-status').textContent = '‚úÖ A√ß√£o e Nota Registradas com Sucesso! (Privado)';
                document.getElementById('note-textarea').value = ''; 
                // For√ßa a UI a atualizar o estado dos bot√µes de log
                renderApp(); 
            } catch (error) {
                console.error("Erro ao registrar Nota Terap√™utica:", error);
                document.getElementById('log-status').textContent = '‚ùå Erro ao salvar log.';
            }
        };

        const handleGoalSave = async () => {
            const goalsFocusTextarea = document.getElementById('goals-focus-textarea');
            const goalsNextStepsTextarea = document.getElementById('goals-next-steps-textarea');
            
            const focus = goalsFocusTextarea.value;
            const nextSteps = goalsNextStepsTextarea.value;
            
            appState.goals = { focus, nextSteps };
            
            const goalsDocRef = doc(appState.db, getPatientGoalsPath(appState.user.userId));
            
            // Re-renderiza com status de salvando
            document.getElementById('app').innerHTML = renderHeader() + renderMainContent({ status: 'Salvando...' }) + renderFooter();
            attachHeaderEvents();
            
            try {
                await setDoc(goalsDocRef, appState.goals, { merge: true });
                // Re-renderiza com status de sucesso
                document.getElementById('app').innerHTML = renderHeader() + renderGoalSettingScreen('‚úÖ Metas salvas com sucesso! (Privado)') + renderFooter();
            } catch (error) {
                console.error("Erro ao salvar metas:", error);
                // Re-renderiza com status de erro
                document.getElementById('app').innerHTML = renderHeader() + renderGoalSettingScreen('‚ùå Erro ao salvar metas.') + renderFooter();
            }
            
            // Re-anexar eventos ap√≥s a renderiza√ß√£o
            attachHeaderEvents();
            attachMainContentEvents();
        };


        const attachMainContentEvents = () => {
            // Dashboard do Cuidador
            const aiButton = document.getElementById('request-ai-button');
            if (aiButton) {
                aiButton.addEventListener('click', handleAIRequest);
            }
            
            const noteTextarea = document.getElementById('note-textarea');
            const approveLogButton = document.getElementById('approve-log-button');
            const rejectLogButton = document.getElementById('reject-log-button');

            if (noteTextarea && approveLogButton && rejectLogButton) {
                // Habilita/Desabilita bot√µes ao digitar
                const updateLogButtons = () => {
                    const isDisabled = noteTextarea.value.trim().length === 0;
                    approveLogButton.disabled = isDisabled;
                    rejectLogButton.disabled = isDisabled;
                };
                noteTextarea.addEventListener('input', updateLogButtons);
                updateLogButtons(); // Chama na anexa√ß√£o
                
                // Anexa eventos de log
                approveLogButton.addEventListener('click', () => logTherapyAction(approveLogButton.dataset.action));
                rejectLogButton.addEventListener('click', () => logTherapyAction(rejectLogButton.dataset.action));
            }

            // Metas do Paciente
            const saveGoalsButton = document.getElementById('save-goals-button');
            const goalsFocusTextarea = document.getElementById('goals-focus-textarea');
            const goalsNextStepsTextarea = document.getElementById('goals-next-steps-textarea');

            if (saveGoalsButton && goalsFocusTextarea && goalsNextStepsTextarea) {
                const updateGoalData = () => {
                    appState.goals.focus = goalsFocusTextarea.value;
                    appState.goals.nextSteps = goalsNextStepsTextarea.value;
                    saveGoalsButton.disabled = goalsFocusTextarea.value.trim() === '' || goalsNextStepsTextarea.value.trim() === '';
                };

                goalsFocusTextarea.addEventListener('input', updateGoalData);
                goalsNextStepsTextarea.addEventListener('input', updateGoalData);
                saveGoalsButton.addEventListener('click', handleGoalSave);
                
                // Inicializa o estado do bot√£o
                updateGoalData();
            }
        };

        // ===========================================================================
        // ‚öôÔ∏è BLOCO 5: INICIALIZA√á√ÉO DO FIREBASE E LOOP DE DADOS
        // ===========================================================================

        const setupFirestoreListeners = () => {
            if (!appState.db || !appState.authReady) return;

            // --- 5.1. Listener de M√©tricas P√∫blicas (Read/Simula√ß√£o) ---
            const metricsDocRef = doc(appState.db, PUBLIC_METRICS_PATH);
            
            // 5.1.1. Inicia o listener em tempo real
            onSnapshot(metricsDocRef, (docSnap) => {
                let data = { frequenciaCardiaca: 70.0, nivelEstresse: 3.5 };
                if (docSnap.exists()) {
                    data = docSnap.data();
                } else {
                    setDoc(metricsDocRef, data, { merge: true });
                }
                // Garante que os valores s√£o floats
                data.frequenciaCardiaca = parseFloat(data.frequenciaCardiaca.toFixed(1));
                data.nivelEstresse = parseFloat(data.nivelEstresse.toFixed(1));

                updateMetrics(data);
            }, (error) => {
                console.error("Erro ao escutar m√©tricas do Firestore:", error);
            });
            
            // 5.1.2. Simula√ß√£o de escrita (para manter os dados "vivos")
            setInterval(() => {
                const newMetrics = {
                    frequenciaCardiaca: parseFloat((Math.random() * (95 - 70) + 70).toFixed(1)),
                    nivelEstresse: parseFloat((Math.random() * 6 + 1).toFixed(1)),
                    lastUpdate: Date.now()
                };
                setDoc(metricsDocRef, newMetrics, { merge: true }).catch(err => {
                    console.error("Erro ao salvar m√©tricas simuladas no Firestore:", err);
                });
            }, 5000);
            
            // --- 5.2. Carregar Metas do Paciente (Se for paciente) ---
            if (appState.user && appState.user.role === 'Paciente') {
                const goalsDocRef = doc(appState.db, getPatientGoalsPath(appState.user.userId));
                getDoc(goalsDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        updateGoals(docSnap.data());
                    } else {
                        // Valores padr√£o se n√£o houver dados
                        updateGoals({ focus: 'Recupera√ß√£o do sono e redu√ß√£o do estresse di√°rio.', nextSteps: 'Completar 3 sess√µes de respira√ß√£o por semana.' });
                    }
                }).catch(error => console.error("Erro ao carregar metas do paciente:", error));
            }
        };


        const initializeAppAndAuth = async () => {
            const app = initializeApp(firebaseConfig);
            appState.auth = getAuth(app);
            appState.db = getFirestore(app);
            
            // Log Level: Essencial para diagnosticar problemas de conex√£o no console
            setLogLevel('debug'); 

            // Tenta autenticar
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(appState.auth, initialAuthToken);
                } else {
                    await signInAnonymously(appState.auth);
                }
            } catch (e) {
                console.error("Erro na autentica√ß√£o Firebase:", e);
            }

            // Observador de estado de autentica√ß√£o
            onAuthStateChanged(appState.auth, (currentUser) => {
                if (currentUser) {
                    console.log("Usu√°rio autenticado:", currentUser.uid);
                }
                appState.authReady = true;
                
                // Carregar estado do usu√°rio (local storage)
                const token = localStorage.getItem('token');
                const encryptedName = localStorage.getItem('encryptedName');
                const role = localStorage.getItem('role');
                
                if (token && encryptedName && role) {
                    const name = mockDecrypt(encryptedName); 
                    appState.user = { name, token, role, userId: localStorage.getItem('userId') };
                    appState.currentScreen = role === 'Cuidador' ? 'Dashboard' : 'Progresso';
                }

                // FIX CRUCIAL: Desativa o estado de carregamento ap√≥s a verifica√ß√£o de autentica√ß√£o
                appState.isLoading = false; 
                
                // Renderiza ap√≥s a autentica√ß√£o e carregamento do estado local
                renderApp();
                setupFirestoreListeners();
            });
        };

        // Inicia a aplica√ß√£o no carregamento da janela
        window.onload = () => {
            appState.isLoading = true; // Define o estado inicial de carregamento
            renderApp(); // Renderiza o ecr√£ de carregamento
            initializeAppAndAuth();
        };

    </script>
</body>
</html>
