<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
// -*- coding: utf-8 -*-
import React, { useState, useEffect, useCallback, useMemo } from 'react';

// ===========================================================================
// üõ†Ô∏è BLOCO 0: CONFIGURA√á√ÉO DO FIREBASE E FERRAMENTAS
// ===========================================================================

// Importa√ß√µes Firebase - CORRIGIDAS para o formato React/NPM
// O ambiente Canvas resolve estas importa√ß√µes internamente.
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
// Importa√ß√£o de setLogLevel adicionada para diagn√≥stico de conex√£o
import { getFirestore, doc, setDoc, onSnapshot, getDoc, setLogLevel } from 'firebase/firestore'; 

// Vari√°veis globais (dispon√≠veis no ambiente Canvas)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Constantes de Caminho do Firestore ---
// Dados P√∫blicos/Compartilhados:
const PUBLIC_METRICS_PATH = `/artifacts/${appId}/public/data/health_metrics/patient_001`;
// Dados Privados (Log de A√ß√£o do Cuidador e Metas do Paciente) - Usamos patient_002 como o ID do Paciente de Teste
const getTherapyLogPath = (caregiverUserId) => `/artifacts/${appId}/users/${caregiverUserId}/therapy_notes/patient_002_log`;
const getPatientGoalsPath = (patientUserId) => `/artifacts/${appId}/users/${patientUserId}/goals/current_focus`;

// ===========================================================================
// üåü BLOCO 1: MICROSSERVI√áO DE PROTE√á√ÉO E COMPAIX√ÉO (Mocks de Back-end)
// ===========================================================================

// --- 1.1. MOCK DE CRIPTOGRAFIA AES-256 (Pilar de Prote√ß√£o) ---
const mockEncrypt = (data) => {
  if (!data || typeof data !== 'string') return '';
  const encrypted = data.split('').map(char => String.fromCharCode(char.charCodeAt(0) ^ 123)).join('');
  return btoa(encrypted); 
};

const mockDecrypt = (encrypted) => {
  if (!encrypted) return '';
  try {
    const decoded = atob(encrypted);
    const decrypted = decoded.split('').map(char => String.fromCharCode(char.charCodeAt(0) ^ 123)).join('');
    return decrypted;
  } catch (e) {
    return 'ERRO: Falha ao descriptografar dado.';
  }
};

// --- 1.2. MOCK DE AUTENTICA√á√ÉO JWT (Pilar de Prote√ß√£o) ---
const mockAuthLogin = (username, password) => {
  if (username === 'medico' && password === '123') {
    const encryptedName = mockEncrypt("Dr. Jo√£o Cust√≥dio (Cuidador)");
    return { token: 'jwt.medic.token', userId: 'medic001', name: "Dr. Jo√£o Cust√≥dio", role: 'Cuidador', encryptedName };
  }
  if (username === 'paciente' && password === '123') {
    const encryptedName = mockEncrypt("Maria da Silva (Paciente)");
    return { token: 'jwt.patient.token', userId: 'patient002', name: "Maria da Silva", role: 'Paciente', encryptedName };
  }
  return null;
};

// --- 1.3. MOCK DO MOTOR DE TERAPIA DE IA (Pilar de Compaix√£o) ---
const simulateAIAdjustment = async (metrics) => {
  const { frequenciaCardiaca, nivelEstresse } = metrics;
  
  const predicao = nivelEstresse > 5.5 ? 'Risco Elevado' : 'Seguro/Est√°vel';
  let ajusteRecomendado = 'Manter a terapia atual (Protocolo 8R+).';

  if (predicao === 'Risco Elevado') {
    if (nivelEstresse > 7.0) {
      ajusteRecomendado = 'PAUSA IMEDIATA. Recomendar biofeedback neuroemocional (√Åudio 432Hz). Ativar dose de resgate de IL-15 (Imunol√≥gico).';
    } else if (frequenciaCardiaca > 90) {
      ajusteRecomendado = 'Ajuste de Foco. Reduzir a dificuldade da sess√£o cognitiva em 25%. Priorizar hidrata√ß√£o e Microbiota (Curcumina).';
    }
  } else {
    if (nivelEstresse < 3.0 && frequenciaCardiaca < 75) {
      ajusteRecomendado = 'Avan√ßo de Fase. O paciente responde bem. Sugerir introdu√ß√£o da pr√≥xima etapa Gen√©tica (CRISPR/Cas9) e aumento da complexidade da Imunoterapia.';
    }
  }

  return new Promise(resolve => setTimeout(() => resolve({ predicao, ajusteTerapeutico: ajusteRecomendado, mensagemAI: 'An√°lise de Risco Completa' }), 1000));
};

// ===========================================================================
// üñ•Ô∏è BLOCO 2: COMPONENTES DE INTERFACE E VISTAS
// ===========================================================================

// --- Header ---
const Header = ({ onNavigate, currentScreen, user, handleLogout }) => {
  const isCaregiver = user?.role === 'Cuidador';
  // Adiciona a nova tela de Metas para o paciente
  const navItems = isCaregiver 
    ? ['Dashboard', 'Monitoramento', 'Relat√≥rios', 'Perfil']
    : ['Progresso', 'Metas', 'Respira√ß√£o', 'Perfil'];

  return (
    <header className="bg-gradient-to-r from-blue-900 to-indigo-800 text-white shadow-xl p-4 sticky top-0 z-10">
      <div className="max-w-7xl mx-auto flex justify-between items-center">
        <h1 className="text-2xl font-extrabold tracking-tight cursor-pointer" onClick={() => onNavigate(isCaregiver ? 'Dashboard' : 'Progresso')}>
          Protocolo 8R+
        </h1>
        <nav className="flex space-x-4">
          {navItems.map(screen => (
            <button
              key={screen}
              onClick={() => onNavigate(screen)}
              className={`px-3 py-1 rounded-full text-sm font-medium transition-all ${
                currentScreen === screen ? 'bg-indigo-400 shadow-md transform scale-105' : 'hover:bg-indigo-600'
              }`}
            >
              {screen}
            </button>
          ))}
        </nav>
        <div className="flex items-center space-x-4">
          <span className="text-sm font-light hidden sm:inline">{user?.role === 'Cuidador' ? 'M√âDICO' : 'PACIENTE'}: {user?.name.split(' ')[0]}</span>
          <button
            onClick={handleLogout}
            className="px-3 py-1 rounded-full text-sm font-medium bg-red-500 hover:bg-red-600 transition-all shadow-md"
          >
            Sair
          </button>
        </div>
      </div>
    </header>
  );
};

// --- Ecr√£ de Login (N√£o Alterado) ---
const LoginScreen = ({ onLogin }) => {
  const [username, setUsername] = useState('medico');
  const [password, setPassword] = useState('123');
  const [error, setError] = useState('');

  const handleLogin = () => {
    setError('');
    const user = mockAuthLogin(username, password);
    
    if (user) {
      localStorage.setItem('token', user.token);
      localStorage.setItem('userId', user.userId);
      localStorage.setItem('encryptedName', user.encryptedName);
      localStorage.setItem('role', user.role);
      onLogin(user);
    } else {
      setError('Credenciais inv√°lidas. Tente M√©dico/123 ou Paciente/123');
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-8 border-indigo-600">
        <h2 className="text-3xl font-bold text-center text-gray-900 mb-6">Acesso ao Protocolo 8R+</h2>
        {error && <p className="text-red-600 bg-red-100 p-2 rounded-lg mb-4 text-sm text-center">{error}</p>}
        
        <label className="block text-sm font-medium text-gray-700 mb-1">Nome de Usu√°rio</label>
        <input
          type="text"
          value={username}
          onChange={(e) => setUsername(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4"
          placeholder="medico ou paciente"
        />

        <label className="block text-sm font-medium text-gray-700 mb-1">Senha</label>
        <input
          type="password"
          value={password}
          onChange={(e) => setPassword(e.target.value)}
          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-6"
          placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        />

        <button
          onClick={handleLogin}
          className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 shadow-lg transform hover:scale-[1.01]"
        >
          Entrar (Simula√ß√£o JWT)
        </button>
        <p className="mt-4 text-xs text-center text-gray-500">
          üîì **CONTAS TESTE:** medico/123 (Cuidador) | paciente/123 (Paciente)
        </p>
      </div>
    </div>
  );
};


// --- Log de A√ß√£o Terap√™utica (Novo Componente) ---
const TherapyNoteLog = ({ db, user, aiAdjustment, currentMetrics }) => {
  const [note, setNote] = useState('');
  const [logStatus, setLogStatus] = useState(null);

  const logTherapyAction = useCallback(async (action) => {
    if (!db || !user || !aiAdjustment || !note) {
      setLogStatus('‚ö†Ô∏è A nota √© obrigat√≥ria para o registro.');
      return;
    }
    
    setLogStatus('Registrando...');
    const logData = {
      caregiverId: user.userId,
      patientId: 'patient002', // Hardcoded para o nosso paciente de teste
      actionType: action,
      aiRecommendation: aiAdjustment.ajusteTerapeutico,
      caregiverNote: note,
      metricsSnapshot: currentMetrics,
      timestamp: Date.now(),
    };
    
    // Caminho privado do Cuidador
    const logDocRef = doc(db, getTherapyLogPath(user.userId));

    try {
        await setDoc(logDocRef, { 
            latestLog: logData,
        }, { merge: true });
        
        setLogStatus('‚úÖ A√ß√£o e Nota Registradas com Sucesso! (Privado)');
        setNote('');
    } catch (error) {
        console.error("Erro ao registrar Nota Terap√™utica:", error);
        setLogStatus('‚ùå Erro ao salvar log.');
    }
  }, [db, user, aiAdjustment, note, currentMetrics]);
  
  if (!aiAdjustment) return null;

  return (
    <div className="bg-gray-50 p-4 rounded-xl shadow-inner border border-gray-200 mt-4">
      <h4 className="text-lg font-bold text-gray-800 border-b pb-2 mb-3">
        Registro de A√ß√£o Terap√™utica (Pilar da Prote√ß√£o - Log de Governan√ßa)
      </h4>
      <textarea
        value={note}
        onChange={(e) => setNote(e.target.value)}
        placeholder="Adicione suas notas sobre a decis√£o (Ex: Aprovado, mas ajustei a dose...) (Obrigat√≥rio)"
        className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm"
        rows="3"
      />
      <div className="mt-3 flex justify-end space-x-3">
        <button
          onClick={() => logTherapyAction('Aprovado e Executado')}
          disabled={!note || logStatus === 'Registrando...'}
          className="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition disabled:opacity-50"
        >
          Aprovar & Registrar
        </button>
        <button
          onClick={() => logTherapyAction('Rejeitado/Ajuste Manual')}
          disabled={!note || logStatus === 'Registrando...'}
          className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition disabled:opacity-50"
        >
          Rejeitar & Registrar
        </button>
      </div>
      {logStatus && <p className="mt-3 text-sm text-center font-medium text-gray-700">{logStatus}</p>}
    </div>
  );
};


// --- Dashboard do Cuidador (Atualizado com Log) ---
const CaregiverDashboard = ({ user, db }) => {
  const [metrics, setMetrics] = useState({ frequenciaCardiaca: 0, nivelEstresse: 0 });
  const [aiAdjustment, setAiAdjustment] = useState(null);
  const [loading, setLoading] = useState(false);
  
  // 1. ONSNAPSHOT: Escutar mudan√ßas no Firestore em tempo real
  useEffect(() => {
    if (!db) return;

    const docRef = doc(db, PUBLIC_METRICS_PATH);
    const unsubscribe = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        setMetrics({
          frequenciaCardiaca: data.frequenciaCardiaca || 0,
          nivelEstresse: data.nivelEstresse || 0
        });
      } else {
        setMetrics({ frequenciaCardiaca: 70, nivelEstresse: 3.5 });
        setDoc(docRef, { frequenciaCardiaca: 70, nivelEstresse: 3.5, lastUpdate: Date.now() }, { merge: true });
      }
    }, (error) => {
      console.error("Erro ao escutar m√©tricas do Firestore:", error);
    });

    return () => unsubscribe();
  }, [db]);
  
  // 2. SIMULA√á√ÉO: Mant√©m a simula√ß√£o, mas agora ESCREVE no Firestore
  useEffect(() => {
    if (!db) return;

    const interval = setInterval(() => {
      const newMetrics = {
        frequenciaCardiaca: parseFloat((Math.random() * (95 - 70) + 70).toFixed(1)),
        nivelEstresse: parseFloat((Math.random() * 6 + 1).toFixed(1)),
        lastUpdate: Date.now()
      };
      
      const docRef = doc(db, PUBLIC_METRICS_PATH);
      setDoc(docRef, newMetrics, { merge: true }).catch(err => {
        console.error("Erro ao salvar m√©tricas simuladas no Firestore:", err);
      });
      
    }, 5000); 

    return () => clearInterval(interval);
  }, [db]);


  const handleAIRequest = async () => {
    setLoading(true);
    setAiAdjustment(null);
    try {
      const adjustment = await simulateAIAdjustment(metrics);
      setAiAdjustment(adjustment);
    } catch (error) {
      setAiAdjustment({ predicao: 'Erro', ajusteTerapeutico: 'Falha de comunica√ß√£o com o Motor de Terapia.', mensagemAI: 'Erro.' });
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (predicao) => {
    if (predicao.includes('Risco')) return 'bg-red-500 border-red-500';
    if (predicao.includes('Seguro')) return 'bg-green-500 border-green-500';
    return 'bg-yellow-500 border-yellow-500';
  };

  return (
    <div className="max-w-7xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
      <h2 className="text-4xl font-extrabold text-gray-900 mb-6 border-b pb-2">
        Dashboard do Cuidador | Vis√£o Integrada (IA)
      </h2>
      
      <div className="grid md:grid-cols-3 gap-6 mb-8">
        {/* Bloco de Monitoramento */}
        <div className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
          <h3 className="text-xl font-semibold text-gray-700 mb-4 flex items-center"><span className="text-indigo-500 mr-2">‚ù§Ô∏è</span> Monitoramento Real-Time (Firestore)</h3>
          <p className="text-4xl font-bold text-gray-800">{metrics.frequenciaCardiaca} <span className="text-lg font-normal">BPM</span></p>
          <p className="text-4xl font-bold text-gray-800 mt-2">{metrics.nivelEstresse} <span className="text-lg font-normal">Estresse (0-10)</span></p>
          <p className="text-xs text-green-500 mt-3">‚úÖ Dados persistentes e em tempo real.</p>
        </div>

        {/* Bloco da IA e Log de A√ß√£o */}
        <div className="md:col-span-2 bg-white p-6 rounded-xl shadow-2xl border-l-4 border-purple-600">
          <h3 className="text-xl font-semibold text-purple-700 mb-4 flex items-center"><span className="text-purple-600 mr-2">üß†</span> Motor de Terapia (IA Adaptativa)</h3>
          
          <button
            onClick={handleAIRequest}
            disabled={loading}
            className="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition duration-150 disabled:opacity-50 flex justify-center items-center"
          >
            {loading ? 'Analisando dados...' : 'Solicitar Ajuste Terap√™utico da IA'}
          </button>

          {aiAdjustment && (
            <div className={`mt-4 p-4 rounded-xl shadow-inner bg-opacity-10 border-l-4 ${getStatusColor(aiAdjustment.predicao)}`}>
              <p className="font-bold text-gray-800">Previs√£o da IA: <span className={`uppercase font-extrabold text-white px-2 py-0.5 rounded-full text-sm ${getStatusColor(aiAdjustment.predicao).replace('border-', 'bg-')}`}>{aiAdjustment.predicao}</span></p>
              <p className="mt-2 text-gray-700 text-lg font-medium">{aiAdjustment.ajusteTerapeutico}</p>
            </div>
          )}
          
          {/* NOVO: Componente de Log */}
          {user && <TherapyNoteLog db={db} user={user} aiAdjustment={aiAdjustment} currentMetrics={metrics} />}
        </div>
      </div>
    </div>
  );
};

// --- Defini√ß√£o de Foco e Metas (Novo Ecr√£ do Paciente) ---
const GoalSettingScreen = ({ user, db }) => {
  const [goals, setGoals] = useState({ focus: '', nextSteps: '' });
  const [loading, setLoading] = useState(true);
  const [saveStatus, setSaveStatus] = useState('');
  
  // Garante que o docRef s√≥ √© criado se db e user.userId existirem
  const goalsDocRef = useMemo(() => (db && user.userId) ? doc(db, getPatientGoalsPath(user.userId)) : null, [db, user.userId]);

  // Carregar metas existentes (ONCE)
  useEffect(() => {
    const fetchGoals = async () => {
      if (!goalsDocRef) return;
      try {
        const docSnap = await getDoc(goalsDocRef);
        if (docSnap.exists()) {
          setGoals(docSnap.data());
        } else {
          setGoals({ focus: 'Recupera√ß√£o do sono e redu√ß√£o do estresse di√°rio.', nextSteps: 'Completar 3 sess√µes de respira√ß√£o por semana.' });
        }
      } catch (error) {
        console.error("Erro ao carregar metas:", error);
      } finally {
        setLoading(false);
      }
    };
    fetchGoals();
  }, [goalsDocRef]);

  const handleSaveGoals = async () => {
    if (!goalsDocRef) return;
    setSaveStatus('Salvando...');
    try {
      await setDoc(goalsDocRef, goals, { merge: true });
      setSaveStatus('‚úÖ Metas salvas com sucesso! (Privado)');
    } catch (error) {
      console.error("Erro ao salvar metas:", error);
      setSaveStatus('‚ùå Erro ao salvar metas.');
    } finally {
      setTimeout(() => setSaveStatus(''), 3000);
    }
  };

  if (loading) return <div className="p-6 text-center text-xl">Carregando metas...</div>;

  return (
    <div className="max-w-4xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
      <h2 className="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">
        Metas e Foco Pessoal (Pilar da Co-cria√ß√£o)
      </h2>
      <div className="bg-white p-8 rounded-xl shadow-2xl border-l-8 border-teal-600">
        <p className="text-gray-600 mb-6">
          Definir o seu foco ajuda a IA e o seu Cuidador a orientarem melhor o Protocolo 8R+.
        </p>

        <label className="block text-lg font-semibold text-gray-700 mb-2">Foco Principal Atual</label>
        <textarea
          value={goals.focus}
          onChange={(e) => setGoals({ ...goals, focus: e.target.value })}
          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-6"
          rows="3"
        />

        <label className="block text-lg font-semibold text-gray-700 mb-2">Pr√≥ximos Passos Terap√™uticos</label>
        <textarea
          value={goals.nextSteps}
          onChange={(e) => setGoals({ ...goals, nextSteps: e.target.value })}
          className="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 mb-6"
          rows="3"
        />
        
        <button
          onClick={handleSaveGoals}
          disabled={!goals.focus || !goals.nextSteps}
          className="w-full py-3 bg-teal-600 text-white font-bold text-lg rounded-lg shadow-lg hover:bg-teal-700 transition transform hover:scale-[1.01] disabled:opacity-50"
        >
          {saveStatus || 'Salvar Minhas Metas'}
        </button>
      </div>
    </div>
  );
};


// --- Ecr√£s Existentes (Passados como placeholders) ---
const ProfileScreen = ({ user }) => { 
    // Simplified ProfileScreen for V6 demo purposes
    const [profileName, setProfileName] = useState('');
    const [protocol, setProtocol] = useState('');
    const [loading, setLoading] = useState(true);
    
    const initialEncryptedProtocol = useMemo(() => mockEncrypt("Fase 1: Ajuste Imunol√≥gico e Neuroemocional - Protocolo Alpha-1"), []);

    useEffect(() => {
        const encryptedName = localStorage.getItem('encryptedName');
        const decryptedName = mockDecrypt(encryptedName); 
        const decryptedProtocol = mockDecrypt(initialEncryptedProtocol);
        setProfileName(decryptedName || 'N√£o Encontrado');
        setProtocol(decryptedProtocol);
        setLoading(false);
    }, [initialEncryptedProtocol]);
    
    if (loading) return <div className="p-6 text-center text-xl">Carregando perfil seguro...</div>;

    return (
        <div className="max-w-3xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
            <h2 className="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">Perfil do Paciente (Pilar de Prote√ß√£o AES-256)</h2>
            <div className="bg-white p-8 rounded-xl shadow-2xl space-y-6">
                <div>
                    <label className="text-sm font-medium text-gray-500 block mb-1">Nome Decriptografado</label>
                    <p className="text-xl font-bold text-gray-900">{profileName}</p>
                </div>
                <div>
                    <label className="text-sm font-medium text-gray-500 block mb-1">Protocolo 8R+ Atual (Dado Sens√≠vel)</label>
                    <p className="text-lg text-gray-800 bg-indigo-50 p-3 rounded-lg border-l-4 border-indigo-400">{protocol}</p>
                </div>
            </div>
        </div>
    );
};


const PatientProgressScreen = ({ db }) => { 
    const [metrics, setMetrics] = useState({ frequenciaCardiaca: 0, nivelEstresse: 0 });
    useEffect(() => {
      if (!db) return;
      const docRef = doc(db, PUBLIC_METRICS_PATH);
      const unsubscribe = onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          setMetrics({ frequenciaCardiaca: data.frequenciaCardiaca || 0, nivelEstresse: data.nivelEstresse || 0 });
        }
      });
      return () => unsubscribe();
    }, [db]);
    
    return (
        <div className="max-w-4xl mx-auto p-6 bg-gray-50 min-h-[90vh]">
            <h2 className="text-4xl font-extrabold text-gray-900 mb-8 border-b pb-2">Meu Progresso 8R+ (Pilar de Co-cria√ß√£o)</h2>
            <div className="bg-white p-8 rounded-xl shadow-2xl">
                <h3 className="text-2xl font-semibold text-gray-800 mb-4">M√©tricas Vivas</h3>
                <p className="text-xl text-gray-700 font-medium">Batimento Card√≠aco: <span className="text-indigo-600 font-bold">{metrics.frequenciaCardiaca} BPM</span></p>
                <p className="text-xl text-gray-700 font-medium mt-2">N√≠vel de Estresse: <span className="text-indigo-600 font-bold">{metrics.nivelEstresse} (0-10)</span></p>
                <p className="mt-6 text-sm text-green-500">Dados em tempo real via Firestore.</p>
            </div>
        </div>
    );
};
const BreathingExerciseScreen = () => { return <div className="p-6 text-center text-xl font-semibold">Exerc√≠cio de Respira√ß√£o Guiada (M√≥d. Co-cria√ß√£o)</div>; };
const HealthMonitorScreen = () => { return <div className="p-6 text-center text-xl font-semibold">Monitoramento Detalhado (M√≥d. M√©dico) - Placeholder</div>; };
const ReportsScreen = () => { return <div className="p-6 text-center text-xl font-semibold">Relat√≥rio Anal√≠tico (M√≥d. M√©dico) - Placeholder</div>; };


// ===========================================================================
// üöÄ BLOCO 3: APP PRINCIPAL (ROTEAMENTO CENTRALIZADO - O N√ì)
// ===========================================================================

const MainContentRouter = ({ user, currentScreen, db }) => {
  if (user.role === 'Cuidador') {
    switch (currentScreen) {
      case 'Dashboard': return <CaregiverDashboard user={user} db={db} />;
      case 'Monitoramento': return <HealthMonitorScreen />;
      case 'Relat√≥rios': return <ReportsScreen />;
      case 'Perfil': return <ProfileScreen user={user} />;
      default: return <CaregiverDashboard user={user} db={db} />;
    }
  } 
  else { // Paciente
    switch (currentScreen) {
      case 'Progresso': return <PatientProgressScreen user={user} db={db} />;
      case 'Metas': return <GoalSettingScreen user={user} db={db} />; // NOVO
      case 'Respira√ß√£o': return <BreathingExerciseScreen />;
      case 'Perfil': return <ProfileScreen user={user} />;
      default: return <PatientProgressScreen user={user} db={db} />;
    }
  }
};


const App = () => {
  const [user, setUser] = useState(null);
  const [currentScreen, setCurrentScreen] = useState('Dashboard');
  const [db, setDb] = useState(null);
  const [authReady, setAuthReady] = useState(false);

  // 1. Inicializa√ß√£o Firebase e Autentica√ß√£o
  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    setDb(firestore);
    
    // Configura√ß√£o de Log: Obrigat√≥ria para diagnosticar problemas de conex√£o do Firestore
    setLogLevel('debug'); 

    const authenticate = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Erro na autentica√ß√£o Firebase:", e);
      }
    };
    authenticate();

    const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
      if (currentUser) {
        console.log("Usu√°rio autenticado:", currentUser.uid);
      }
      setAuthReady(true);
    });

    return () => unsubscribe();
  }, []);

  // 2. Carregar estado do usu√°rio (local storage)
  useEffect(() => {
    if (!authReady) return; // Espera a autentica√ß√£o

    const token = localStorage.getItem('token');
    const encryptedName = localStorage.getItem('encryptedName');
    const role = localStorage.getItem('role');
    
    if (token && encryptedName && role) {
      const name = mockDecrypt(encryptedName); 
      setUser({ name, token, role, userId: localStorage.getItem('userId') }); // Inclui userId
      setCurrentScreen(role === 'Cuidador' ? 'Dashboard' : 'Progresso');
    }
  }, [authReady]);

  const handleLogin = (userInfo) => {
    setUser(userInfo);
    setCurrentScreen(userInfo.role === 'Cuidador' ? 'Dashboard' : 'Progresso');
  };

  const handleLogout = () => {
    localStorage.clear();
    setUser(null);
    setCurrentScreen('Dashboard');
  };

  const isLoading = !authReady;

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <p className="text-xl font-medium text-indigo-600">Conectando ao N√∫cleo de Dados...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 font-sans">
      <script src="https://cdn.tailwindcss.com"></script>
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      
      {user && <Header onNavigate={setCurrentScreen} currentScreen={currentScreen} user={user} handleLogout={handleLogout} />}
      
      <main>
        {user ? (
          <MainContentRouter user={user} currentScreen={currentScreen} db={db} />
        ) : (
          <LoginScreen onLogin={handleLogin} />
        )}
      </main>
      
      <footer className="p-4 text-center text-xs text-gray-500 border-t mt-4">
        Sistema Protocolo 8R+ Integrado V6. **Expans√£o Funcional Ativada:** Log de A√ß√£o Terap√™utica (Prote√ß√£o) e Defini√ß√£o de Metas (Co-cria√ß√£o).
      </footer>
    </div>
  );
};

export default App;

  }

    </script>
</body>
</html>


